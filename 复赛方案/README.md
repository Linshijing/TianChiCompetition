
## 方案总体思路
主要思路，让骑士尽可能在一个小范围商家区域内取单，每个骑士只取用户距离比较相近的单子，取完一些订单后，在统一进行送单。这样骑士就尽可能在起点终点两点直线配送。
因此需要对商圈内的商家进行聚类，以及商家对应的用户进行聚类。同时，由于不同的商家，订单产生量在时间上有差异，比如有的是卖早餐，有的卖午餐，用户群体不同，学生，上班白领，用餐时间也有差异。因此引入时间变量，不同时间段内单独进行聚类。整体方案由**动态区域划分的规则模型**和**调度模型**构成，详细思路如下图所示。

![enter image description here](https://tianchi-public.oss-cn-hangzhou.aliyuncs.com/public/files/forum/159117553022473461591175524900.png)
## 算法具体介绍
### 动态区域划分的规则模型
动态区域划分的规则模型，是通过对历史数据进行挖掘。


 1. 时间区域划分
我们按照等订单量原则，将调度时间划分为了5个区间段。实际上应该划分为多少个时间区段，是需要尝试，根据实验结果确定，甚至不同的商圈应该设置不同，由于时间关系，仅是简单取了个5。
 2. 商家聚类模型
采用“Kmeans”算法，根据商家的**经纬度**和**订单产生频率**，其实就是根据所有订单的商家**经纬度**进行聚类。聚类个数基本都为9个，个别设置了7个，9个，聚类个数也是需要实验确定，我们做了几组实验，最后确定了9个相对比较好，由于本地有3个商圈的测试数据，因此我们对这三个进行了实验，单独确定了它们的聚类个数。
 3. 客户距离模型
同样采用“Kmeans”算法，不同的是，以每个商家簇的聚类中心为原点，将客户的经纬度转化为极坐标，以**角度**进行聚类，使骑士从该商家簇出发，沿某一个方向进行送单。聚类个数基本设置为9个。
 4. 骑士额定取单容量
 骑手额定取单容量指的是骑士取完多少个订单后，开始进行送单。根据数据统计，订单量随着调度时间增加，逐渐上升，因此我们设置额定取单容量前期小后期大，从1-3逐渐增加。原来应该是不同的商家簇的客户簇单独设置骑士的额定取单容量，但是这样的话参数会变得特别多，一个一个的去寻找最优值，会耗费很多时间精力，因此我们简化成了，只随时间而变化。

**注意**：在实际操作过程中，由于团队内部沟通理解上的失误，导致我们在聚类模型的训练中，没有考虑订单产生频率，我们筛掉了重复位置的数据，因此原本聚类模型应该是不同的时间段，由于订单产生频率不同，得到的模型也不同，变成了在整个调度时间轴上，保持不变，这影响了我们后面的成绩。
### 调度模型

 1. 调度时刻
 我们采用两分钟进行一次调度
 
 2. 给商家簇分配骑士策略
 根据商家簇所需的最大骑士容量和最小骑士容量与当前可调度骑士的数量关系，就近原则按需分配。
 所需骑士最大容量：当前调度时间区段内，该商家簇可能产生的订单总量。根据历史数据统计得到。
 所需骑士最小容量：当前调度时刻，该商家簇现在尚存未分配的订单数量。
 当商圈的最小骑士容量和小于可调度骑士数量时，根据每个商家簇的最小骑士容量一一分配骑士，多余骑士按照所需最大骑士容量比例进行分配。
 当商圈的最小骑士容量和小于可调度骑士数量时，此时骑士数量不够分，只能根据商家簇的所需最小骑士容量的比例进行分配。
 
 3. 订单分配给骑士的策略
 每个商家簇，都有各自拥有的骑士，根据订单可以取单时间的大小，由小到大排序，依次分配给骑士，骑士只接收一个客户簇的所有订单。若订单没有合适的骑士，则保留至下一轮的调度。
 
 4. 骑士到店取单规划
 当骑士接到的订单小于4时，采用穷举的方式，选择耗时最少的到店取单动作顺序，大于4时，根据订单与骑士的距离由近到远进行取单。
 
 5. 判断骑士是否该进入送单状态
 当骑士接到的订单数大于等于设置的额定取单量，骑士进入送单状态，或者虽然未达到额定取单量，但是骑士已经完成了当前接到的所有订单的取单动作，也进入送单状态。进入送单状态的骑士，只送单，不接新订单，直到送完所有订单后，重新纳入可调度骑士，重新进行分配给商家簇。
 
 6. 骑士送单规划
 当骑士待送订单大于4时，根据距离从近到远进行送单，订单小于等于4时，采用穷举，选择超时单数最少的送单顺序组合。
## 代码文件说明
### model文件夹
该文件夹下的，dataProcess.ipynb是构建动态区域划分模型的代码，采用的是官方提供的历史数据进行挖掘；order_history_20200420是官方提供的历史数据。
### dispatch
该文件夹下的dispatch-demo-py文件夹是调度程序，所需的规则模型和参数在/demp/model下，直接运行local_judge.py文件就可以进行调度。
### 环境需求
scikit-learn==0.22.1,过高的版本，一些接口函数需要自行修改，其他flask,jinja2,numpy,pandas,scipy默认最新即可。