# 解决方案介绍
## 解决方案总体思路
骑手在面临行为决策时，存在多个待取订单和多个待送订单，我们团队将骑手行为预测问题分为两个阶段进行解决。
1. 阶段一：骑手决策时，先考虑从多个需要取的订单中选出最有可能取的订单，和从多个需要送的订单中选出最有可能送的订单，称之为“选单阶段”
2. 阶段二：骑手在经过阶段一的选单后，进行取单还是送单的决策，确定最终的行为，称之为“决策阶段”

对于行为时间的预测，原本想采用回归模型进行拟合的，由于时间关系，以及初赛只看行为预测准确率，因此仅通过计算实际时间与理论时间（距离除以骑手速度）的差值的平均值，进行处理。
## 算法具体介绍
### 阶段一：选单算法模型
首先对数据进行预处理，分为取单数据和送单数据，并将提供的多个表的信息进行整合。

取单数据和送单数据又进一步进行分成了一个待取订单，两个待取订单、三个待取订单、四个及以上待取订单，一个待送订单，两个待送订单、三个待送订单、四个及以上待送订单，8类数据。

只有一个订单时，直接选择；多于三个待选订单时，这部分数据较少，处理也比较麻烦，因此直接考虑选择距离最近的订单。

双待取订单，根据骑手与两个订单取单商家位置的距离差是否为0，分为两类数据。距离差不为0的数据，根据数据分析，发现，当待取订单距离差大于1500米时，此时根据距离大小直接选择订单，正确率95%左右，因此这些情况下，模型只通过距离差进行选择订单。剩余距离差不为0数据和距离差为0的数据分别通过随机森林建模，得到**双取单距离差为0模型**和**双取单距离差不为0模型**。

双待送订单，根据骑手与两个订单送达客户位置的距离差是否为0，分为两类数据。距离差不为0的数据，根据数据分析，发现，当待送订单距离差大于1000米时，此时根据距离大小直接选择订单，正确率95%左右，因此这些情况下，模型只通过距离差进行选择订单。剩余距离差不为0数据和距离差为0的数据分别通过随机森林建模，得到**双送单距离差为0模型**和**双送单距离差不为0模型**。

三待取订单，根据骑手与三个订单取单商家位置的距离差是否都为0，还是部分为0，分为3类情况，分别采用随机森林进行建模，得到**三取单距离差都为0模型**、**三取单距离差都不为0模型**、和**三取单距离差部分为0模型**。

三待送订单，根据骑手与三个订单送单客户位置的距离差是否都为0，还是部分为0，分为3类情况。由于距离差都为0的数据较少，因此直接通过订单的承诺送达时间大小进行选择。距离差都不为0和部分为0，分别采用随机森林进行建模，得到**三送单距离差都不为0模型**、和**三送单距离差部分为0模型**。

以上的模型都是采用随机森林构建，共得到9个模型，特征为订单之间的**理论完成时间差**、**订单分配时间差**、**订单可取时间差**、**订单承诺送达时间差**等差值的全部或者部分，模型参数没有进行详细的调参优化。

### 阶段二：决策算法模型
通过阶段一的选单过程后，骑手面临取单还是送单的二选一决策，是个二分类问题。

通过统计发现，当骑手与取单位置与送单位置的距离差大于1200时，此时根据距离大小，进行决策，能够达到95%的正确率，因此这种情况下，直接根据距离进行决策

当距离差小于1200时，根据距离差区间[0,100],[101,300],[301,1200],[-1200,-400],[-399,-200],[-199,-100],[-99,0],划分为7类数据，分别采用随机森林建模，特征仍然采用取单和送单之间的**理论完成时间差**、**订单分配时间差**、**订单可取时间差**、**订单承诺送达时间差**等差值。训练时，排除掉阶段一选单错误的数据。

## 提交文件说明
对提交的部分数据文件和代码进行说明介绍。
### feature文件夹
#### 数据预处理.ipynb
该代码实现将训练数据（2月数据）进行整理划分为**取单数据**和**送单数据**,得到结果对应于“user_data/tmp_data/”下的**pickAll.txt**和**deliveryAll.txt**。 **注意**：由于得到的.txt文件超过了100M，github不好上传，已删除，可以通过程序在运行得到，运行该程序需要较长的时间，好几个小时。

#### 阶段1训练集特征构建.ipynb
该代码以数据预处理得到的数据为输入，整理划分订单为双订取单，双订单送单，三订单取单和三订单送单四类数据集，得到结果对应于“user_data/tmp_data/”下的**pickTwo.txt**、**deliveryTwo.txt**、**pickThree.txt**和**deliveryThree.txt**。由于表有太多列，这里不展示了，可以看相应的txt文件，看整理后的数据样式。**注意**：由于得到的.txt文件超过了100M，github不好上传，已删除，可以通过程序在运行得到，运行该程序需要较长的时间，好几个小时。

#### 阶段2训练集特征构建.ipynb
该代码是在完成阶段一选单模型训练后，进行下一步的阶段2模型训练的数据集准备工作，以数据预处理得到的数据为输入，通过选单模型，得到骑手决策点，最有可能取的单和最有可能送的单，结果对应于“user_data/tmp_data/”下的**decisionData.txt**。**注意**：由于得到的.txt文件超过了100M，github不好上传，已删除，可以通过程序在运行得到，运行该程序需要较长的时间，好几个小时。

#### 测试集阶段1阶段2特征构建.ipynb
该代码是对线上测试集数据（B榜）进行预处理，采用阶段一的模型得到最后阶段2模型的输入数据。结果对应于“user_data/tmp_data/”下的**decision_20200301.txt**、**decision_20200302.txt**、**decision_20200303.txt**、**decision_20200304.txt**、**decision_20200305.txt**和**decision_20200306.txt**。若要进行A榜数据处理，需要修改下路径。

### model文件夹
该文件夹放的是模型构建训练代码，调参优化工作没有做，因而没有调参优化的代码。

#### 阶段1选单模型.ipynb
通过随机森林对不同情况下的订单选择进行建模，得到的结果对应于“user_data/model_data/choose_model/”下的**RFpick2.pkl**(双取单距离差不为0模型)、**RFpickSame2.pkl**(双取单距离差为0模型)、**RFDE2.pkl**(双送单距离差不为0模型)、**RFDESame2.pkl**(双送单距离差为0模型)、**RFpick3.pkl**(三取单距离差都不为0模型)、**RFpickpartSame3.pkl**(三取单距离差部分为0模型)、**RFpickSame3.pkl**(三取单距离差都为0模型)、**RFDE3.pkl**(三送单距离差都不为0模型)、**RFDEpartSame3.pkl**(三送单距离差部分为0模型)。

#### 阶段2决策模型.ipynb
以阶段2训练集特征构建.ipynb得到的数据集，根据距离差进行分区，分为7类数据，分别采用随机森林进行建模训练，得到的模型结果对应于“user_data/model_data/decision_model/”下的**RFdecision_dis1.pkl**、**RFdecision_dis2.pkl**、**RFdecision_dis3.pkl**、**RFdecision_dis4.pkl**、**RFdecision_dis5.pkl**、**RFdecision_dis6.pkl**、**RFdecision_dis7.pkl**共7个模型。

### code文件夹
#### main.py
该代码通过加载“user_data/model_data/decision_model/”下的训练好的模型，对“user_data/tmp_data/”下的经过阶段1选单处理后的decision_x.txt数据进行骑手行为预测和时间估计。输出结果对应于“action_predict/”下的数据。

### 代码运行说明
main.py可以直接通过 pythom main.py 运行，其他的.ipynb 需要通过jupyter notebook 进行逐行运行。